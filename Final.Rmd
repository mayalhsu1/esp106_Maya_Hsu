---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
date: "2023-03-06"
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

path <- "/Users/mayahsu/Desktop/school/environmental data science/esp106_Maya_Hsu/"

knitr::opts_knit$set(root.dir = path)
setwd(path)
library(tidyverse)
library(tidyr)
library(ggplot2)
housing <- read.csv("https://raw.githubusercontent.com/mayalhsu1/esp106_Maya_Hsu/main/ACSCP1Y2021.CP04-2023-03-15T072503.csv")
projected <- read.csv("https://raw.githubusercontent.com/mayalhsu1/esp106_Maya_Hsu/main/table-a-housing-development-applications-submitted.csv")
demographic <- read.csv("https://raw.githubusercontent.com/mayalhsu1/esp106_Maya_Hsu/808243c7a23cddf66bb9998d6640d19c26a7a202/county%20data.csv")
```

```{r}
housing <- t(housing) #transposing the data

headers <- housing[1, ] #extracted values from row 1 as a vector 
colnames(housing) <- headers #renamed columns with row 1 values
housing <- housing[-1, ] #removed first row
housing <- housing[-165, ] #removed empty row
```

```{r}
Years <- c("2021", "2019", "2018", "2017") #creating list of dates
Years <- rep(Years, 41) #repeating dates
as.data.frame(Years) #data frame
housing <- cbind(housing, Years) #adding dates to housing data
```

```{r}
County <- rownames(housing)
County <- substr(County, 1, nchar(County)-34)
as.data.frame(County)
County <- gsub(".", " ", County, fixed = TRUE)
rownames(housing) <- 1:nrow(housing)

housing <- gsub("N", NA, housing)
housing <- gsub("(X)", NA, housing)

housing <- cbind(housing, County)
```

```{r}
housing_type <- housing[ ,c(9:17)]
housing_type <- gsub("%", "", housing_type, fixed = TRUE)
housing_type <- as.data.frame(housing_type)
housing_type <- sapply(housing_type, as.numeric)
housing_type <- housing_type/100

housing_type <- as.data.frame(housing_type)

housing_type <- cbind(housing_type, housing[ ,161:162])
```

```{r}
projected$CNTY_NAME <- str_to_title(projected$CNTY_NAME)
#projects that where approved with SB35
i = projected$APP_SUBMITTED_SB35 == "Yes-Approved"
SB35 <- projected[i,]
```

```{r}
counties <- unique(SB35$CNTY_NAME)
counties <- sort(counties)
```

```{r}
h2021 <- subset(housing_type, Years == "2021")
sb35_housing_type <- subset(h2021, County %in% counties)
names_sb35 <- sb35_housing_type[, 11]
sb35_housing_type <- subset(sb35_housing_type, select = -c(10, 11))

color <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')

sb_type <- colnames(sb35_housing_type)
sb_type <- str_squish(sb_type)

sb35_housing_type <- as.matrix(sb35_housing_type)
sb35_housing_type <- t(sb35_housing_type)

#png(filename = "/Users/mayahsu/Desktop/school/environmental data science/final/Current Housing Data", width = 5, height = 5, units = "in", res = 300)
par(mar=c(4,5,5,5)+.1, xpd = TRUE)
barplot(sb35_housing_type, horiz = TRUE, names.arg = names_sb35, cex.names = 0.4, las = 1, col = color, main = "Housing Type in Counties With\nApproved SB35 Projects", xlab = "Proportion", cex.axis = 0.5, width = 1, cex.lab = 0.7, xlim = c(0,1), ylim = c(0, 32))
legend("right", inset = -0.19, legend = sb_type, fill = color, cex = 0.5, title = "Housing Type")
#dev.off()
```


```{r}
units <- aggregate(SB35[, 20], by = list(SB35$CNTY_NAME), sum) #number of sb35 units approved
colnames(units) <- c("County", "Units")

med_income <- as.data.frame(demographic[ ,c(1,2,29)])
med_income <- med_income[-c(59,60), ]
colnames(med_income) <- c("County", "Population","Median Income")

income <- med_income[ ,3]
income <- gsub("$", "", income, fixed = TRUE)
income <- gsub(" ", "", income, fixed = TRUE)
income <- gsub(",", "", income, fixed = TRUE)
income <- as.data.frame(income)
income <- sapply(income, as.numeric)
med_income[ ,3] <- income

population <- med_income[ ,2]
population <- gsub(",", "", population, fixed = TRUE)
population <- as.data.frame(population)
population <- sapply(population, as.numeric)
med_income[ ,2] <- population

approved_v_income <- merge(units, med_income, by = "County")
approved_v_income[ ,5] <- approved_v_income[ ,2]/approved_v_income[ ,3]
colnames(approved_v_income) <- c("County", "Count", "Population", "Median Income", "Units/Person")

ggplot(approved_v_income, aes(x = approved_v_income[ ,4], y = approved_v_income[ ,5]))+
  geom_point()+geom_smooth(method = "lm")+
  labs(x = "Median Income", y = "SB35 Projects per Person")

cor.test(approved_v_income[ ,4], approved_v_income[ ,5])
```


```{r}
sub <- housing[ , c(2, 161, 162)]
#sub <- subset(sub, County %in% SB35_agg[ ,1])
sub <- as.data.frame(sub)
sub <- subset(sub, Years == 2017 | Years == 2021)
sub <- sub[-c(145, 148), ]
sub[ ,1] <- gsub(",", "", sub[ ,1], fixed = TRUE)
sub[ ,1:2] <- sapply(sub[ ,1:2], as.numeric)


colnames(sub) <- c("Total Housing Units", "Year", "County")

sub <- pivot_wider(sub, names_from = "Year", values_from = "Total Housing Units")
sub[ ,4] <- (sub[ ,2]-sub[ ,3])/sub[ ,3]
colnames(sub) <- c("County", "2021",  "2017", "Percent Change in Housing")

change_v_sb35 <- merge(sub, units, by = "County")
change_v_sb35 <- merge(change_v_sb35, approved_v_income, by = "County")

ggplot(change_v_sb35, aes(x = change_v_sb35[ ,4], y = change_v_sb35[ ,9]))+
  geom_point()+geom_smooth(method = "lm")+
  labs(x = "Percent Change in Total Housing", y = "Number of Approved SB35 Projects")

cor.test(change_v_sb35[ ,4], change_v_sb35[ ,9])
```

```{r}
new_type <- as.data.frame(projected[ ,c(2, 9)])

all_projected <- data.frame(v1 = character(), v2 = numeric(), v3 = character())

a <- unique(new_type$CNTY_NAME)
for(i in 1:length(a)) {
b = new_type$CNTY_NAME == a[i]
temp <- new_type[b,]
temp[,3] <- 1
temp <- aggregate(temp[,3], by = list(temp$UNIT_CAT), sum)
sum <- sum(temp[,2])
temp[,3] <- temp[,2]/sum
temp[ ,2] <- NULL
temp[ ,3] <- a[i]
all_projected <- rbind(all_projected, temp)
}

colnames(all_projected) <- c("Type", "%", "County")
all_projected <- pivot_wider(all_projected, names_from = "Type", values_from = "%")
all_projected[ ,1] <- NULL

all_projected[is.na(all_projected)] <- 0

all_projected <- t(all_projected)


par(mar=c(4,5,5,5)+.1, xpd = TRUE)
barplot(all_projected, horiz = TRUE, names.arg = a, cex.names = 0.4, las = 1, col = color, main = "Housing Type in Counties With\nApproved SB35 Projects", xlab = "Proportion", cex.axis = 0.5, width = 1, cex.lab = 0.7, xlim = c(0,1), ylim = c(0, 32))
legend("right", inset = -0.19, legend = sb_type, fill = color, cex = 0.5, title = "Housing Type")

```